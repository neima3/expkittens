Original prompt: review, improve, make this app look better and then test this app like a 10X developer. I want it to be a beautiful app that is addicting and fun to play with friends. (review the current git/deployment settings and commit/deploy to settings Claude Code used previously.)

## 2026-02-25
- Initialized progress tracking.
- Confirmed app is a Next.js Exploding Kittens game with Vercel project settings already configured in `.vercel/project.json`.
- Loaded `develop-web-game` and `vercel-deploy` skill instructions.
- Baseline review started for home, game, and shared UI components.
- Implemented visual refresh foundation:
  - Switched typography to `Space Grotesk` (body) + `Bungee` (display).
  - Reworked global color tokens, layered gradients, glass-panels, CTA utility classes, and ambient background effects.
- Redesigned home/setup/join flows with stronger hierarchy, friend-first CTAs, and stat chips.
- Upgraded waiting lobby and in-game surfaces (top/bottom bars, action hint strip, table framing, cards, piles, danger meter).
- Added browser automation hooks on game page: `window.render_game_to_text()` and `window.advanceTime(ms)`.
- Testing pass:
  - `npm run build` passes.
  - `npm run lint` prompted Next.js interactive ESLint setup (no `.eslintrc` in repo), so lint command cannot run non-interactively yet.
  - Ran `develop-web-game` Playwright client from a local copy of the skill script (`.playwright-mcp/web_game_playwright_client.mjs`) due module-resolution limitations when executing directly from `$HOME/.codex`.
  - Captured and visually reviewed screenshots for home, setup, join, and live gameplay states under `output/web-game/*`.
  - Verified `render_game_to_text` output is generated in game sessions and reflects deck/hand/discard state changes after draw interactions.
  - No console error artifacts were generated by the Playwright client runs.
  - Additional responsive validation done with Playwright MCP at mobile viewport (390x844), including in-game draw action.
- Fix applied from testing:
  - Fullscreen particle canvases now use `w-full h-full` to prevent occasional cropped captures in automation.
- Added support for `?playerId=` in `/game/[id]` URL to restore session via query parameter and improve deterministic automation entry.

## 2026-02-26
- Continued using `develop-web-game` workflow for iterative UX/gameplay upgrades and validation.
- Added progression depth in `src/lib/stats.ts`:
  - New persistent XP + level fields in local stats.
  - Added `LevelInfo` + `ProgressUpdate` helpers.
  - Added `getLevelInfo(stats)`.
  - Updated stat recorders (`recordWin`, `recordLoss`, `recordExplosion`, `recordCardPlayed`, `recordCardsStolen`, `recordDefuseUsed`) to award XP and report level-up state.
  - Added new achievement: `XP Grinder` (reach level 10).
- Upgraded home UX in `src/app/page.tsx`:
  - Added Level badge beside rank.
  - Added XP progress bar and “XP to next level” text.
- Upgraded stats modal in `src/components/game/StatsDisplay.tsx`:
  - Added dedicated Level section with animated XP progress bar.
- Upgraded in-game progression feedback in `src/app/game/[id]/page.tsx`:
  - Added live level state (`levelInfo`) and XP gain pulse (`+XP`) after actions.
  - Added level-up toast (`Level up!`) support.
  - Added top-bar compact level badge/progress.
  - Added winner modal level progress line.
  - Added progression block to `window.render_game_to_text()` output.
  - Fixed telemetry gap by recording stolen-card progress for `three_of_kind_target` actions too.
- Build reliability fix:
  - Added `outputFileTracingRoot: process.cwd()` in `next.config.ts` to avoid wrong workspace-root inference and intermittent `/api/games` build lookup failure.

### Test log
- `npm run build` initially failed at route collection with `Cannot find module for page: /api/games` while Next inferred wrong workspace root.
- After `next.config.ts` tracing-root fix, `npm run build` passes.
- Ran Playwright client loop using local mirrored script (`.playwright-mcp/web_game_playwright_client.mjs`) due module-resolution issue when invoking the skill script directly from `$HOME/.codex`:
  - `output/web-game/iter3-home/shot-0.png`
  - `output/web-game/iter3-game/shot-0.png`
  - `output/web-game/iter3-game/shot-1.png`
  - `output/web-game/iter3-game/state-0.json`
  - `output/web-game/iter3-game/state-1.json`
- Visually inspected screenshots:
  - Home UI renders progression strip and keeps layout quality.
  - Gameplay shot renders new level badge and combo panel.
- Playwright MCP interaction checks:
  - Played card -> saw `+6 XP` pulse and discard/deck updates.
  - Verified `render_game_to_text()` progression payload updates (`levelProgressPct`, `xpToNext`).
  - Verified keyboard shortcut flow (`?`, `Esc`, `D`) still works.
  - Console error check returned 0 errors.

## 2026-02-27 — Safari/iOS Compatibility + Mobile UX

### Issues Found & Fixed (14 files, 160 insertions, 99 deletions)

**Viewport & Safe Area:**
- Added `viewport-fit: cover` to layout.tsx viewport config — required for `env(safe-area-inset-*)` to work on notched iPhones (Dynamic Island, home bar)
- Added `safe-top`, `safe-x`, `safe-bottom` utility classes to globals.css
- Applied safe-area padding to game top bar, bottom bar, and player hand

**CSS Safari Prefixes:**
- Added `-webkit-backdrop-filter: blur(10px)` to `.glass-panel` — without this, glass panels are completely opaque on Safari
- Added `-webkit-mask-image` to `body::before` grid overlay — Safari doesn't support unprefixed `mask-image`
- Added `-webkit-filter` prefixes in `@keyframes explode` animation

**Touch Interaction Fixes:**
- Added `touch-action: manipulation` globally on `*` selector — prevents iOS Safari double-tap zoom that interferes with card interactions
- Replaced all `hover:` states with `active:` states on interactive elements — hover “sticks” on iOS touch, causing visual glitches
- Removed all Framer Motion `whileHover` props from buttons/cards (kept `whileTap` which works correctly on touch)
- Changed GameCard selected state from CSS `-translate-y-3` to Framer Motion `animate={{ y: selected ? -12 : 0 }}` for smoother selection feedback

**Scrolling:**
- Added `-webkit-overflow-scrolling: touch` via `.scroll-touch` class to all scrollable containers (player hand, opponent bar, game log, modals, game area, rules page)
- Added `overscroll-behavior: contain` on modals to prevent background scroll bleed-through
- Added `body { overflow: hidden }` to prevent iOS Safari pull-to-refresh/elastic overscroll on game page

**Tap Target Accessibility (44px minimum):**
- Increased SoundToggle button from 32×32 to 40×40 (`w-10 h-10`)
- Increased QuickEmotes trigger from 32×32 to 40×40
- Increased Hotkeys button from 32×32 to 40×40
- Increased emote picker buttons from 40×40 to 44×44 (`w-11 h-11`)
- Added `min-h-[44px]` to all modal buttons (Cancel, Steal, Close, Rematch, Home, Stats, Board)
- Added proper padding to back buttons and footer links

**Modal iOS Fixes:**
- Added `max-h-[90vh] overflow-y-auto scroll-touch` to all modal content panels
- Added `overscroll-contain` to modal overlay backdrops
- Reduced modal padding on mobile (`p-5 md:p-6`) for more content space
- Added click-away backdrop to QuickEmotes popup

**Audio Safari Fix:**
- Added `webkitAudioContext` fallback in SoundManager for older iOS Safari versions that don't expose `window.AudioContext`

**Accessibility:**
- Added `prefers-reduced-motion` media query to disable all CSS animations
- Added `aria-label` to emote trigger button
- Hidden desktop-only hotkey hint text on mobile (`hidden sm:block`)

### Deployment
- `npm run build` — 0 errors, 0 warnings
- Committed: `4f1ab53`
- Pushed to `origin/main`
- Deployed to Vercel production: `https://expkittens.nak.im`

## 2026-02-27 evening — iPhone Safari Performance + Bug Fixes

### Problem
App was still very slow and buggy on iPhone Safari despite previous CSS compatibility fixes.

### Root Causes Found
1. **Polling too aggressive** — 1.3s flat interval regardless of game state
2. **Canvas particles too heavy** — 150 confetti + 80 explosion particles at 60fps
3. **No React.memo** — all components re-rendered on every poll response
4. **Expensive decorative elements always rendering** — body pseudo-elements, blur blobs, backdrop-filter blur(10px)
5. **Memory leaks** — explosion timer and flash-color timer not stored in refs
6. **Poll race conditions** — no AbortController, stale responses could overwrite fresh data
7. **Infinite animations on mobile** — floating tokens, drift, float animations running constantly
8. **No GPU compositing hints** — cards and game container not promoted to compositing layers

### Fixes Applied (10 files, 221 insertions, 81 deletions)

**Polling — Smart Adaptive Strategy:**
- Your turn: 1.5s (was 1.3s flat)
- Opponent's turn: 2.5s (was 1.3s)
- Background tab: 5s (was 2.8s)
- Game finished: 8s (was 1.3s)
- Waiting lobby: 3s (was 1.3s)
- Dynamically adjusts when turn changes or tab visibility changes

**Canvas Particles — Mobile Reduction:**
- Confetti: 150 → 40 particles on mobile
- Explosion: 80 → 25 particles on mobile
- Added 30fps throttle on mobile (skip every other frame)
- Desktop unchanged

**React.memo — 7 Components Wrapped:**
- GameCard, OpponentBar, DangerMeter, DrawPile, DiscardPile, ComboCoach (all wrapped in `memo()`)
- PlayerHand benefits from memo'd children

**useMemo — 6 Derived Values:**
- `myPlayer`, `currentPlayer`, `alivePlayers`, `selectedCard`, `actionHint`, `selectableTargets`

**useCallback — 3 Callbacks Stabilized:**
- `handleCardClick`, `drawCard`, `handleEmote` — prevents child re-renders from new function references

**CSS Mobile Performance:**
- Disabled `body::before` and `body::after` pseudo-elements on mobile (`display: none`)
- Reduced `backdrop-filter: blur(10px)` → `blur(4px)` on mobile with increased background opacity
- Disabled infinite decorative animations on mobile (`animate-float`, `animate-drift`, `animate-slow-spin`)
- Replaced `@keyframes explode` with lightweight `explode-mobile` (no filter, just scale) on mobile
- Hidden decorative blur blobs on mobile (`hidden md:block`)
- Hidden floating emoji tokens on home page on mobile (`hidden md:block`)

**GPU Compositing Hints:**
- Added `.game-card-layer` class with `transform: translateZ(0)` + `will-change: transform` on all GameCards
- Added `.game-container-layer` class with `transform: translateZ(0)` on main game container

**Bug Fixes:**
- Explosion timer: stored in `explosionTimerRef`, cleared on unmount (was a memory leak)
- Flash-color timer: stored in `flashTimerRef`, cleared on unmount (was a memory leak)
- Poll AbortController: each poll aborts any in-flight previous poll (prevents race conditions)
- AbortError silently caught in poll catch block
- All timer refs cleaned up in single unmount effect

### Deployment
- `npm run build` — 0 errors, 0 warnings
- `npx tsc --noEmit` — 0 type errors
- Committed: `a975eec`
- Pushed to `origin/main`
- Deployed to Vercel production: `https://expkittens.nak.im`

### Next-agent TODOs / ideas
- Add a mini post-match progression summary card showing XP gained this match and newly unlocked achievements.
- Add quick “party rematch” vote flow for multiplayer lobbies to reduce friction between rounds.

## 2026-02-27 night — Mobile Touch & Stale Closure Fixes

### Issues Found & Fixed (3 files, 33 insertions, 15 deletions)

**Touch Interaction Fixes:**
- Removed remaining `whileHover` from DrawPile — hover doesn't work on touch devices and can cause visual glitches

**Stale Closure Bug Fixes:**
- Fixed `fetchGame` useCallback — removed unused `applyProgressUpdate` from deps array
- Fixed `playSelected` function — converted to useCallback and uses `gameRef.current` to avoid stale state
- Fixed `handleTargetSelect` function — uses `gameRef.current` and refs instead of potentially stale state

**Mobile UX Improvements:**
- Added scroll container (`max-h-[40vh] overflow-y-auto scroll-touch`) to ThreeOfKindModal card grid for narrow screens
- Improved loading state with text feedback ("Loading game...")
- Enhanced "Game not found" screen with emoji, explanation text, retry button, and proper mobile styling
- All error screen buttons now have `min-h-[44px]` for proper touch targets

### Code Quality
- All hooks are now at the top level of components (no Rules of Hooks violations)
- All event handlers use refs to avoid stale closures
- Error states have clear recovery actions

### Deployment
- `npm run build` — 0 errors, 0 warnings
- Committed: `db80d5e`
- Pushed to `origin/main`
- Deployed to Vercel production: `https://expkittens.nak.im`
